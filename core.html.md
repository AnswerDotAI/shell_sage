# Core


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## Imports

------------------------------------------------------------------------

### CodeBlock.\_\_rich_console\_\_

``` python

def __rich_console__(
    console, options
):

```

------------------------------------------------------------------------

### Chat

``` python

def Chat(
    arg:VAR_POSITIONAL, kw:VAR_KEYWORD
):

```

*Lazy load lisette to make ssage more responsive*

Jupyter does work with rich.live.Live, this fixes it.

``` python
@contextmanager
def Live(start, **kw):
    print(start)
    def update(s, refresh=False): clear_output(True);print(s)
    yield NS(update=update)
```

``` python
def print_md(md_stream):
    "Print streamed markdown"
    with Live(Spinner("dots", text="Connecting..."), auto_refresh=False) as live:
        for part in md_stream: live.update(Markdown(part), refresh=True)
```

## Model Setup

## System Environment

``` python
# aliases = _aliases('bash')
# print(aliases)
```

``` python
# print(_sys_info())
```

## Tmux

------------------------------------------------------------------------

### get_pane

``` python

def get_pane(
    n, pid:NoneType=None
):

```

*Get output from a tmux pane*

``` python
# p = get_pane(20)
# print(p[:512])
```

------------------------------------------------------------------------

### get_panes

``` python

def get_panes(
    n
):

```

``` python
# ps = get_panes(20)
# print(ps[:512])
```

``` python
co(['tmux', 'display-message', '-p', '#{history-limit}'], text=True).strip()
```

    '2000'

------------------------------------------------------------------------

### tmux_history_lim

``` python

def tmux_history_lim(
    
):

```

``` python
tmux_history_lim()
```

    2000

------------------------------------------------------------------------

### get_history

``` python

def get_history(
    n, pid:str='current'
):

```

## Options and ShellSage

------------------------------------------------------------------------

### get_opts

``` python

def get_opts(
    opts:VAR_KEYWORD
):

```

``` python
opts = get_opts(model=None, log=None, api_base=None, api_key=''); opts
```

<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'provider'</span>: <span style="color: #008000; text-decoration-color: #008000">'anthropic'</span>, <span style="color: #008000; text-decoration-color: #008000">'model'</span>: <span style="color: #008000; text-decoration-color: #008000">'claude-opus-4-5'</span>, <span style="color: #008000; text-decoration-color: #008000">'think'</span>: <span style="color: #008000; text-decoration-color: #008000">'l'</span>, <span style="color: #008000; text-decoration-color: #008000">'search'</span>: <span style="color: #008000; text-decoration-color: #008000">'l'</span>, <span style="color: #008000; text-decoration-color: #008000">'trust'</span>: <span style="color: #008000; text-decoration-color: #008000">'view,rg'</span>, 
<span style="color: #008000; text-decoration-color: #008000">'history_lines'</span>: <span style="color: #008000; text-decoration-color: #008000">'1000'</span>, <span style="color: #008000; text-decoration-color: #008000">'code_theme'</span>: <span style="color: #008000; text-decoration-color: #008000">'xcode'</span>, <span style="color: #008000; text-decoration-color: #008000">'code_lexer'</span>: <span style="color: #008000; text-decoration-color: #008000">'python'</span>, <span style="color: #008000; text-decoration-color: #008000">'log'</span>: <span style="color: #008000; text-decoration-color: #008000">'True'</span>, <span style="color: #008000; text-decoration-color: #008000">'safecmd'</span>: <span style="color: #008000; text-decoration-color: #008000">'True'</span><span style="font-weight: bold">}</span>
</pre>

``` python
{'api_base': '', 'api_key': '', 'log': True, 'model': 'claude-opus-4-5'}
```

Rich’s `Live` display and `input()` can’t coexist — `Live` manages the
terminal cursor, and `input()` needs it too. When `Live.stop()` is
called, it prints its current renderable as static text, which causes
duplication since `get_res` accumulates the full response. The fix:
clear Live’s renderable before stopping, flush the accumulated response
as static markdown, and reset the buffer. This way streaming resumes
fresh after the tool interaction with no overlap.

------------------------------------------------------------------------

### with_permission

``` python

def with_permission(
    action_desc
):

```

``` python
print(tools[1]('.'))
```

<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Directory contents of <span style="color: #800080; text-decoration-color: #800080">/Users/jhoward/aai-ws/shell_sage/</span><span style="color: #ff00ff; text-decoration-color: #ff00ff">nbs</span>:
<span style="color: #800080; text-decoration-color: #800080">/Users/jhoward/aai-ws/shell_sage/nbs/</span><span style="color: #ff00ff; text-decoration-color: #ff00ff">00_core.ipynb</span>
<span style="color: #800080; text-decoration-color: #800080">/Users/jhoward/aai-ws/shell_sage/nbs/</span><span style="color: #ff00ff; text-decoration-color: #ff00ff">_quarto.yml</span>
<span style="color: #800080; text-decoration-color: #800080">/Users/jhoward/aai-ws/shell_sage/nbs/</span><span style="color: #ff00ff; text-decoration-color: #ff00ff">sidebar.yml</span>
<span style="color: #800080; text-decoration-color: #800080">/Users/jhoward/aai-ws/shell_sage/nbs/</span><span style="color: #ff00ff; text-decoration-color: #ff00ff">styles.css</span>
<span style="color: #800080; text-decoration-color: #800080">/Users/jhoward/aai-ws/shell_sage/nbs/</span><span style="color: #ff00ff; text-decoration-color: #ff00ff">CNAME</span>
<span style="color: #800080; text-decoration-color: #800080">/Users/jhoward/aai-ws/shell_sage/nbs/</span><span style="color: #ff00ff; text-decoration-color: #ff00ff">01_config.ipynb</span>
<span style="color: #800080; text-decoration-color: #800080">/Users/jhoward/aai-ws/shell_sage/nbs/</span><span style="color: #ff00ff; text-decoration-color: #ff00ff">nbdev.yml</span>
<span style="color: #800080; text-decoration-color: #800080">/Users/jhoward/aai-ws/shell_sage/nbs/</span><span style="color: #ff00ff; text-decoration-color: #ff00ff">index.ipynb</span>
</pre>

------------------------------------------------------------------------

### get_sage

``` python

def get_sage(
    model, mode:str='default', search:bool=False, use_safecmd:bool=False
):

```

``` python
# m = 'ollama_chat/qwen3:8b'
# ssage = get_sage(m)
# ssage('Howdy!')
```

``` python
m = 'claude-sonnet-4-5'
ssage = get_sage(m, search='l')
ssage('Hi, how are ya?', think='l')
```

Hey there! I’m doing well, thanks for asking. Ready to help you navigate
the command line, troubleshoot shell issues, or dive into any system
administration questions you’ve got. What can I help you with today?

<details>

- id: `chatcmpl-96ad87f4-6fd0-4088-a6d6-6bfa0ad36097`
- model: `claude-sonnet-4-5-20250929`
- finish_reason: `stop`
- usage:
  `Usage(completion_tokens=108, prompt_tokens=3387, total_tokens=3495, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=48, rejected_prediction_tokens=None, text_tokens=None, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None, cache_creation_tokens=0, cache_creation_token_details=CacheCreationTokenDetails(ephemeral_5m_input_tokens=0, ephemeral_1h_input_tokens=0)), cache_creation_input_tokens=0, cache_read_input_tokens=0)`

</details>

------------------------------------------------------------------------

### get_res

``` python

def get_res(
    sage, q, opts
):

```

``` python
opts=NS(api_base='', api_key='', think='l')
list(get_res(ssage, 'Use tools to check if we have a  .git in the current directory. Respond with yes/no', opts))
```

    ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', 'No', 'No']

``` python
print_md(get_res(ssage, 'Hi!', opts))
```

<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Hey! What's up? Need help with something?                                                                          
</pre>

``` python
print_md(get_res(ssage, 'Please use your view command to see what files are in the current directory. Only respond with a single paragraph', opts))
```

<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">You're in the <span style="color: #008080; text-decoration-color: #008080; background-color: #000000; font-weight: bold">/Users/jhoward/aai-ws/shell_sage/nbs</span> directory which contains several Jupyter notebooks              
(00_core.ipynb, 01_config.ipynb, index.ipynb), configuration files for Quarto and nbdev (_quarto.yml, nbdev.yml,   
sidebar.yml), a styles.css file, and a CNAME file, suggesting this is an nbdev project setup for documentation     
generation with Quarto.                                                                                            
</pre>

``` python
print_md(get_res(ssage, 'Please search the web for interesting facts about Linux. Only respond with a single paragraph.', opts));
```

<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Linux has a fascinating history and impact on computing: created by Linus Torvalds in 1991 as a hobby project when 
he was just a 21-year-old student, it's now the backbone of the internet with over 96% of the world's top web      
servers running on it, powers Android devices (making it the most widely used OS on the planet), operates the      
International Space Station's computers, runs most supercomputers globally, and is completely open-source with     
thousands of developers contributing to its kernel—all while Torvalds still oversees development today, and the    
penguin mascot "Tux" was named after Torvalds' (T)orvalds (U)ni(X), though the actual inspiration came from a photo
of a penguin that supposedly bit him at an Australian zoo.                                                         
</pre>

## Logging

------------------------------------------------------------------------

### mk_db

``` python

def mk_db(
    
):

```

------------------------------------------------------------------------

### Log

``` python

def Log(
    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD
):

```

*Initialize self. See help(type(self)) for accurate signature.*

``` python
# db = mk_db()
# log = db.logs.insert(Log(timestamp=datetime.now().isoformat(), query='Hi, who are you?', model='llama3.2',
#                          response='I am ShellSage, a command-line teaching assistant!', mode='default'))
# log
```

## Main

------------------------------------------------------------------------

### main

``` python

def main(
    query:str <The query to send to the LLM>, v:<Print version>='%(prog)s 1.0.6',
    pid:str='current', # `current`, `all` or tmux pane_id (e.g. %0) for context
    skip_system:bool=False, # Whether to skip system information in the AI's context
    history_lines:int=None, # Number of history lines. Defaults to tmux scrollback history length
    mode:str='default', # Available ShellSage modes: ['default', 'sassy']
    model:str=None, # The LLM model that will be invoked on the LLM provider
    search:str=None, # Wheather to allow the LLM to search the internet
    api_base:str=None, api_key:str=None,
    think:str=None, # Reasoning effort level: 'l', 'm', 'h' (for supported models)
    trust:str=None, # Comma-delimited list of tools to always allow (e.g. "view,rg")
    code_theme:str=None, # The code theme to use when rendering ShellSage's responses
    code_lexer:str=None, # The lexer to use for inline code markdown blocks
):

```

``` python
main(['Do you have a `bash` tool?.'], history_lines=0)
```

<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Yes, I have a <span style="color: #000000; text-decoration-color: #000000; background-color: #ffffff">bash</span> tool that can run shell commands safely. It supports most standard unix commands, git           
operations, pipes, and shell operators. However, it has an allow-list of safe commands and blocks output file      
redirection (<span style="color: #000000; text-decoration-color: #000000; background-color: #ffffff">&gt;</span>) to prevent accidental overwrites.                                                                  
</pre>

```` python
r = f'''
Hello, user! Here are some code blocks:

```python
for i in range(10): print(i)
```

```
This doesn't even have a language definition!
```

```bash
ls **/*
```
'''
````

``` python
db = mk_db()
db.logs.insert(Log(timestamp=datetime.now().isoformat(), query='', response=r, model='', mode=''))
```

    Log(id=1, timestamp='2025-12-03T04:46:49.790878', query='', response="\nHello, user! Here are some code blocks:\n\n```python\nfor i in range(10): print(i)\n```\n\n```\nThis doesn't even have a language definition!\n```\n\n```bash\nls **/*\n```\n", model='', mode='')

------------------------------------------------------------------------

### extract_cf

``` python

def extract_cf(
    idx
):

```

``` python
extract_cf(0)
```

    'for i in range(10): print(i)'

------------------------------------------------------------------------

### extract

``` python

def extract(
    idx:int, # Index of code block to extract
    copy:bool=False, # Copy to clipboard
    do_print:bool=False, # Print (useful for readline custom shortcuts)
):

```

*Extracts the idx’th codefence from the last shell sage response and
sends it to tmux by default*
